---
layout: post
title: AppStoreå†…è´­
categories: pay
tags: in-app-purchase appstore
---

## å†…è´­ç®€ä»‹

---

App å†…è´­ä¹° (Inâ€‘App Purchase)ï¼Œç®€ç§°ï¼šIAPå†…è´­ã€‚

é€šè¿‡ App å†…è´­ä¹°é¡¹ç›®ï¼Œç›´æ¥åœ¨ App é‡Œä¸ºé¡¾å®¢æä¾›é¢å¤–çš„å†…å®¹å’ŒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ç‰¹çº§å†…å®¹ã€æ•°å­—å•†å“å’Œè®¢é˜…é¡¹ç›®ã€‚æ‚¨æ›´å¯ä»¥ç›´æ¥åœ¨ AppStore ä¸Šæ¨å¹¿å’Œæä¾› App å†…è´­ä¹°é¡¹ç›®ã€‚

å®˜æ–¹æ–‡æ¡£ï¼š[https://developer.apple.com/cn/in-app-purchase/][1]{:target="_blank"}

---

### å•†å“ç±»å‹

---

`æ¶ˆè€—å‹äº§å“(Consumable)`

* å®šä¹‰ï¼šæ¶ˆè€—å‹é¡¹ç›®åªå¯ä½¿ç”¨ä¸€æ¬¡ï¼Œä½¿ç”¨ä¹‹åå³å¤±æ•ˆï¼Œå¿…é¡»å†æ¬¡è´­ä¹°ã€‚
* ç‰¹ç‚¹ï¼šè´­ä¹°çš„å•†å“å¯æ¶ˆè€—ï¼Œå¯é‡å¤è´­ä¹°ã€‚æ¯æ¬¡è´­ä¹°çš„å€¼ä¸€èˆ¬éƒ½ä¼šå åŠ ã€‚å¦‚æœä¹°äº†åï¼Œç”¨æˆ·ä¸æ¶ˆè€—ï¼Œåˆ™ä¸€ç›´å­˜åœ¨ç”¨æˆ·ç›¸å…³çš„è´¦å·ä¸­ã€‚
* ä¸¾ä¾‹ï¼šã€Šçš‡å®¤æˆ˜äº‰ã€‹ä¸­ï¼Œè´­ä¹°å®çŸ³ã€‚

`éæ¶ˆè€—å‹äº§å“(Nonâ€‘Consumable)`

* å®šä¹‰ï¼šéæ¶ˆè€—å“åªèƒ½è´­ä¹°ä¸€æ¬¡ä¸”ä¸ä¼šè¿‡æœŸã€‚
* ç‰¹ç‚¹ï¼šè¿™ç§ç±»å‹çš„å•†å“çš„ç‰¹ç‚¹å°±æ˜¯å½“ç”¨æˆ·è´­ä¹°åï¼Œè¿™ä¸ªå•†å“å°±ä¸€ç›´ç”Ÿæ•ˆï¼Œä¸éœ€è¦é‡å¤è´­ä¹°ã€‚
* ä¸¾ä¾‹ï¼šã€Šæ—…è¡Œé’è›™ã€‹ä¸­ï¼Œè§£é”æ¸¸æˆä¸­çš„ç‰¹å®šé“å…·ã€‚

`éç»­æœŸäº§å“(Nonâ€‘Renewing Subscriptions)`

* å®šä¹‰ï¼šç”¨æˆ·è´­ä¹°æœ‰æ—¶é™æ€§çš„æœåŠ¡æˆ–å†…å®¹ã€‚
* ç‰¹ç‚¹ï¼šæ­¤ç±»è®¢é˜…åˆ°æœŸåä¸ä¼šè‡ªåŠ¨ç»­è®¢ï¼Œç”¨æˆ·éœ€è¦é€æ¬¡ç»­è®¢ã€‚
* ä¸¾ä¾‹ï¼šã€Šè…¾è®¯è§†é¢‘ã€‹ä¸­ï¼ŒVIPä¼šå‘˜åŒ…æœˆã€‚

`è‡ªåŠ¨ç»­æœŸäº§å“(Autoâ€‘Renewable Subscriptions)`

* å®šä¹‰ï¼šç”¨æˆ·è´­ä¹°æœ‰æ—¶é™æ€§çš„æœåŠ¡æˆ–å†…å®¹ï¼Œåˆ°æœŸåè‡ªåŠ¨ç»­è®¢ã€‚
* ç‰¹ç‚¹ï¼šåˆ°æœŸå‰24å°æ—¶ï¼Œè‹¹æœä¼šä¸»åŠ¨æ‰£è´¹ä»è€Œä¸ºç”¨æˆ·è‡ªåŠ¨ç»­è®¢ï¼Œç›´ç”¨æˆ·å–æ¶ˆè‡ªåŠ¨è®¢é˜…ã€‚
* ä¸¾ä¾‹ï¼šã€Šè…¾è®¯è§†é¢‘ã€‹ä¸­ï¼ŒVIPä¼šå‘˜è¿ç»­åŒ…æœˆã€‚

---

### å•†å“å®šä»·

å†…è´­å•†å“å®šä»·ä¸ºå›ºå®šçš„é‡‘é¢ï¼Œåˆ†ä¸ºéè‡ªåŠ¨è®¢é˜…å•†å“å®šä»·ä¸è‡ªåŠ¨è®¢é˜…å•†å“å®šä»·ä¸¤ç±»ã€‚

æ³¨æ„âš ï¸ï¼šå®šä»·å¹¶éå…¨éƒ¨éƒ½æ˜¯æ•´æ•°ï¼Œè‡ªåŠ¨è®¢é˜…çš„å®šä»·åŒ…å«ç±»ä¼¼ `Â¥1.99` çš„å®šä»·ã€‚

ç–‘é—®ğŸ¤”ï¸ï¼šè‹¹æœçš„å®šä»·æ˜¯å›ºå®šçš„ï¼Œå¦‚ä½•æ»¡è¶³äº§å“ä¸šåŠ¡çµæ´»çš„å®šä»·ï¼Ÿ

æŒ‰ç…§æœ€æ¥è¿‘å•†å“ä»·æ ¼çš„è‹¹æœå®šä»·æ‰§è¡Œæ‰£è´¹ï¼Œè®¡ç®—è‹¹æœå®šä»·ä¸å•†å“å®é™…å®šä»·çš„å·®é¢ï¼Œè¿™éƒ¨åˆ†å·®é¢è½¬æ¢ä¸ºè™šæ‹Ÿè´§å¸å‘æ”¾åˆ°ç”¨æˆ·çš„ä½™é¢ä¸­ï¼›

ç–‘é—®ğŸ¤”ï¸ï¼šä»€ä¹ˆæ˜¯è‹¹æœæŠ½æˆï¼Ÿ

ç”±äºåœ¨ä½¿ç”¨è‹¹æœå†…è´­æ—¶ï¼Œæ ¹æ®å•†å“ç±»å‹çš„ä¸åŒï¼Œè‹¹æœä¼šæŒ‰å•†å“å®šä»·æŠ½æˆçº¦30%å·¦å³çš„æ‰‹ç»­è´¹ï¼Œé™„å¸¦ä¸åŒç±»å‹å•†å“çš„ç¨è´¹ï¼Œå®é™…çš„ä¸­é—´è´¹ç”¨
åœ¨30%ï½33%ä¹‹é—´ã€‚

å› æ­¤ï¼Œåœ¨åº”ç”¨å†…è´­ä¹°è™šæ‹Ÿå¸æ—¶ï¼Œå¦‚æœåœ¨å®‰å“ç«¯çš„å…‘æ¢æ¯”ä¾‹ä¸ºï¼š1å…ƒ = 100å®çŸ³ï¼›é‚£ä¹ˆåœ¨è‹¹æœç«¯å…‘æ¢æ¯”ä¾‹ä¸ºï¼š1å…ƒ = 66å®çŸ³ï¼›

`éè‡ªåŠ¨è®¢é˜…å•†å“å®šä»·åˆ—è¡¨`

{:class="table table-striped table-bordered table-hover"}
|price    | level     |
| :-----: | :-------: |
|CNY 6    |ï¼ˆç­‰çº§ 1ï¼‰   |
|CNY 12   |ï¼ˆç­‰çº§ 2ï¼‰   |
|CNY 18   |ï¼ˆç­‰çº§ 3ï¼‰   |
|...      |...         |
|CNY 6498 |ï¼ˆç­‰çº§ 87ï¼‰  |
|CNY 1    |ï¼ˆå¤‡ç”¨ç­‰çº§ Aï¼‰|
|CNY 3    |ï¼ˆå¤‡ç”¨ç­‰çº§ Bï¼‰|
|CNY 8    |ï¼ˆå¤‡ç”¨ç­‰çº§ 1ï¼‰|
|CNY 12   |ï¼ˆå¤‡ç”¨ç­‰çº§ 2ï¼‰|
|CNY 18   |ï¼ˆå¤‡ç”¨ç­‰çº§ 3ï¼‰|
|CNY 28   |ï¼ˆå¤‡ç”¨ç­‰çº§ 4ï¼‰|
|CNY 30   |ï¼ˆå¤‡ç”¨ç­‰çº§ 5ï¼‰|

`è‡ªåŠ¨è®¢é˜…å•†å“å®šä»·åˆ—è¡¨`

{:class="table table-striped table-bordered table-hover"}
|price     | level     |
| :-----:  | :-------: |
|Â¥1.00     | Â¥1.00     |
|Â¥1.99     | Â¥1.99     |
|Â¥3.00     | Â¥3.00     |
|Â¥3.99     | Â¥3.99     |
|...       |...        |
|Â¥6,498.00 | Â¥6,498.00 |

---

### å•†å“ä¿ƒé”€

---

æ¨ä»‹ä¿ƒé”€ä¼˜æƒ æ˜¯é’ˆå¯¹è‡ªåŠ¨ç»­æœŸè®¢é˜…ç±»å•†å“çš„ä¼˜æƒ ä¿ƒé”€æ´»åŠ¨ï¼ŒåŒ…å«å…è´¹è¯•ç”¨å’Œç‰¹ä»·ä¼˜æƒ ï¼Œåˆ†åˆ«é€šè¿‡æ”¶æ®çš„ `is_trial_period` å’Œ `is_in_intro_offer_period` å­—æ®µä½“ç°ï¼›

æ³¨æ„âš ï¸ï¼šå¦‚æœç”¨æˆ·å‚ä¸è¿‡æ¨ä»‹ä¿ƒé”€ä¼˜æƒ ï¼Œåˆ™æ— æ³•å†äº«å—è¯¥å•†å“æ‰€å±è®¢é˜…åˆ†ç»„çš„æ¨ä»‹ä¿ƒé”€ä¼˜æƒ ã€‚å³æ¨ä»‹ä¿ƒé”€çš„ä¼˜æƒ é’ˆå¯¹æ¯ä¸ªè®¢é˜…åˆ†ç»„ï¼Œè‹¹æœåªå…è®¸ç”¨æˆ·äº«å—ä¸€æ¬¡ï¼›

---

## å†…è´­æ¨¡å¼

---

ä¸¤ç§æ¨¡å¼ä¸»è¦çš„ä¸åŒä¹‹å¤„åœ¨äºå¯¹ AppStore è¿”å›çš„ä»˜æ¬¾å‡­è¯ï¼ˆreceiptï¼‰çš„éªŒè¯æ–¹å¼ã€‚

* `å®¢æˆ·ç«¯éªŒè¯æ¨¡å¼`ï¼šåœ¨å®¢æˆ·ç«¯éªŒè¯ä»˜æ¬¾å‡­è¯ï¼ˆreceiptï¼‰ï¼Œç®€å•å¿«æ·ï¼Œä½†å®¹æ˜“è¢«ç ´è§£ã€‚ä¸»è¦é€‚ç”¨äºéè”ç½‘APPåº”ç”¨å†…è´­ï¼Œæ¯”å¦‚ï¼Œã€Šæ—…è¡Œé’è›™ã€‹ä¸­æ¸¸æˆé“å…·è´­ä¹°ã€‚

* `æœåŠ¡å™¨éªŒè¯æ¨¡å¼`ï¼šåœ¨æœåŠ¡ç«¯éªŒè¯ä»˜æ¬¾å‡­è¯ï¼ˆreceiptï¼‰ï¼Œæµç¨‹ç›¸å¯¹å¤æ‚ï¼Œä½†ç›¸å¯¹å®‰å…¨æ€§æ›´é«˜ï¼Œä¸»è¦é€‚ç”¨äºè”ç½‘APPåº”ç”¨çš„å†…è´­ï¼Œæ¯”å¦‚ï¼Œç›´æ’­APPä¸­è™šæ‹Ÿè´§å¸çš„å……å€¼è´­ä¹°ã€‚

---

### å®¢æˆ·ç«¯æ¨¡å¼

---

1. APP ä»æœåŠ¡å™¨è·å–äº§å“æ ‡è¯†åˆ—è¡¨
2. APP ä» AppStore è·å–äº§å“ä¿¡æ¯
3. ç”¨æˆ·é€‰æ‹©éœ€è¦è´­ä¹°çš„äº§å“
4. APP å‘é€æ”¯ä»˜è¯·æ±‚åˆ° AppStore
5. AppStore å¤„ç†æ”¯ä»˜è¯·æ±‚ï¼Œç”¨æˆ·å®Œæˆæ”¯ä»˜åï¼ŒAppStore è¿”å›ä»˜æ¬¾æ”¶æ® (receipt) ç»™APP
6. APP éªŒè¯è¿”å›çš„ä»˜æ¬¾æ”¶æ®(receipt)ï¼Œåˆ¤å®šç”¨æˆ·æ˜¯å¦ä»˜æ¬¾æˆåŠŸå¹¶æä¾›å¯¹åº”çš„æœåŠ¡

---

### æœåŠ¡å™¨æ¨¡å¼

---

<div class="mermaid">
sequenceDiagram
	participant StoreKit as StoreKit
	participant App as iPhone
	participant Server
	participant AppStore
	App->>+Server: 1.è·å–ä¸šåŠ¡è®¢å•å·
	Server-->>-App: 2.è¿”å›ä¸šåŠ¡è®¢å•å·

	rect rgba(0, 0, 255, .1)
	Note over App,StoreKit: è‹¹æœæ”¯ä»˜
	App->>+StoreKit: 3.è¯·æ±‚å•†å“ä¿¡æ¯ï¼ˆproductId)
	StoreKit-->>App: 4.è¿”å›å•†å“ä¿¡æ¯
	App->>StoreKit: 5.åŠ å…¥äº¤æ˜“é˜Ÿåˆ—
	StoreKit-->>App: 6.å¼¹å‡ºäº¤æ˜“å¼¹çª—
	App->>StoreKit: 7.ç”¨æˆ·æ”¯ä»˜
	StoreKit-->>-App: 8.äº¤æ˜“æˆåŠŸï¼Œè¿”å›ä»˜æ¬¾æ”¶æ®
	end
	
	App->>+Server: 9.éªŒè¯è®¢å•çŠ¶æ€ï¼ˆæ ¹æ®æ”¶æ®ã€è®¢å•å·ï¼‰
	Server->>AppStore: 10.éªŒè¯æ”¶æ®æœ‰æ•ˆæ€§
	AppStore-->>Server: 11.è¿”å›æ”¶æ®æœ‰æ•ˆæ€§
	Server-->>-App: 12.è¿”å›å¤„ç†ç»“æœ
	
	App->>StoreKit: 13.å…³é—­äº¤æ˜“
</div>

---

## å†…è´­æ”¶æ®

---

å†…è´­æ”¶æ®æ˜¯ç”¨æˆ·ä»˜æ¬¾åï¼Œè‹¹æœæœåŠ¡å™¨è¿”å›ç»™iOSå®¢æˆ·ç«¯çš„ä¸€ä¸ªä»˜æ¬¾å‡­è¯ï¼Œé€šè¿‡åœ¨å®¢æˆ·ç«¯/æœåŠ¡ç«¯éªŒè¯è‹¹æœçš„æ”¶æ®éªŒè¯ä»˜æ¬¾å‡­è¯çš„çœŸå®æ€§ï¼Œä»è€Œä¸ºç”¨æˆ·æä¾›æ”¶æ®ä¹°å¯¹åº”çš„æœåŠ¡ã€‚

---

### æ”¶æ®é£æ ¼

---

* iOS 6-style transaction receipts
* iOS 7-style transaction receipts

---

### æ”¶æ®éªŒè¯

---

```shell
æ²™ç®±ç¯å¢ƒéªŒè¯ä»˜æ¬¾æ”¶æ®(receipt): https://sandbox.itunes.apple.com/verifyReceipt
ç”Ÿäº§ç¯å¢ƒéªŒè¯ä»˜æ¬¾æ”¶æ®(receipt): https://buy.itunes.apple.com/verifyReceipt

æœ€ä½³å®è·µï¼š
- 
- æ ¹æ®æ”¶æ®ä¸­çš„ bid åæŸ¥å¯¹åº”é…ç½®çš„ app_item_idï¼Œæ ¡éªŒæ˜¯å¦ä¸æ”¶æ®å†…çš„ app_item_id æ˜¯å¦ä¸€è‡´ï¼›
- æ ¹æ®æ”¶æ®ä¸­çš„ product_id åæŸ¥å¯¹åº”é…ç½®çš„ item_idï¼Œæ ¡éªŒæ˜¯å¦ä¸æ”¶æ®å†…çš„ item_id æ˜¯å¦ä¸€è‡´ï¼›
```

---

### æ”¶æ®ç»“æ„

1ã€éè‡ªåŠ¨ç»­æœŸäº§å“æ”¶æ®ç»“æ„

- é’ˆå¯¹éè‡ªåŠ¨ç»­æœŸäº§å“æ”¶æ®ï¼Œoriginal_transaction_id å’Œ transaction_id æ˜¯ç›¸åŒçš„ï¼›

```json
{
    "receipt": {
        "unique_identifier": "...",                     //è‹¹æœåˆ†é…è®¾å¤‡å”¯ä¸€æ ‡è¯†ç¬¦
        "original_transaction_id": "...",               //åŸäº¤æ˜“å·
        "transaction_id": "...",                        //äº¤æ˜“å·
        "unique_vendor_identifier": "...",              //å”¯ä¸€ä¾›åº”å•†æ ‡è¯†
        "product_id": "...",                            //äº§å“åç§°æ ‡è¯†ï¼ˆproduct_idï¼‰
        "quantity": "1",                                //äº¤æ˜“äº§å“æ•°é‡
        "bid": "...",                                   //åº”ç”¨åç§°æ ‡è¯†ï¼ˆbundle_id)
        "is_in_intro_offer_period": "false",            //æ˜¯å¦ç‰¹ä»·ä¼˜æƒ ï¼ˆè¯¦è§æ¨ä»‹ä¿ƒé”€ï¼‰
        "is_trial_period": "false",                     //æ˜¯å¦å…è´¹è¯•ç”¨ï¼ˆè¯¦è§æ¨ä»‹ä¿ƒé”€ï¼‰
        "purchase_date_ms": "1531643137200",            //è´­ä¹°ä»˜æ¬¾æ—¶é—´æˆ³
        "original_purchase_date_ms": "1531643137200",   //åŸäº¤æ˜“ä»˜æ¬¾æ—¶é—´
        "bvrs": "3.96.3.0",
        "app_item_id": "...",                           //åº”ç”¨å”¯ä¸€æ ‡è¯†
        "item_id": "...",                               //äº§å“å”¯ä¸€æ ‡è¯†
        "version_external_identifier": "827233954",
        "purchase_date": "2018-07-15 08:25:37 Etc/GMT",
        "purchase_date_pst": "2018-07-15 01:25:37 America/Los_Angeles",
        "original_purchase_date": "2018-07-15 08:25:37 Etc/GMT",
        "original_purchase_date_pst": "2018-07-15 01:25:37 America/Los_Angeles",
    },
    "status": 0
}
```

2ã€è‡ªåŠ¨ç»­æœŸè®¢é˜…äº§å“æ”¶æ®ç»“æ„
```json
{
  "auto_renew_status": 0,
  "latest_expired_receipt_info": {
    "original_purchase_date_pst": "2018-01-19 16:03:00 America/Los_Angeles",
    "unique_identifier": "9d89432f1fae59f25c05d44553fe40438a865b9f",
    "original_transaction_id": "1000000368245564",
    "expires_date": "1517368991000",
    "transaction_id": "1000000371718901",
    "quantity": "1",
    "product_id": "abc",
    "bvrs": "721180.450460032",
    "bid": "ab.bc",
    "unique_vendor_identifier": "9982B084-BE66-4622-ACCB-6C5B3D9C4CD4",
    "web_order_line_item_id": "1000000037662245",
    "original_purchase_date_ms": "1516406580000",
    "expires_date_formatted": "2018-01-31 03:23:11 Etc/GMT",
    "purchase_date": "2018-01-31 02:53:11 Etc/GMT",
    "is_in_intro_offer_period": "false",
    "purchase_date_ms": "1517367191000",
    "expires_date_formatted_pst": "2018-01-30 19:23:11 America/Los_Angeles",
    "is_trial_period": "false",
    "purchase_date_pst": "2018-01-30 18:53:11 America/Los_Angeles",
    "original_purchase_date": "2018-01-20 00:03:00 Etc/GMT",
    "item_id": "1326212778"
  },
  "status": 21006,
  "auto_renew_product_id": "...",
  "receipt": {
    "original_purchase_date_pst": "2018-01-19 16:03:00 America/Los_Angeles",
    "unique_identifier": "9d89432f1fae59f25c05d44553fe40438a865b9f",
    "original_transaction_id": "1000000368245564",
    "expires_date": "1517359990000",
    "transaction_id": "1000000371686472",
    "quantity": "1",
    "product_id": "...",
    "bvrs": "721180.450460032",
    "bid": "...",
    "unique_vendor_identifier": "9982B084-BE66-4622-ACCB-6C5B3D9C4CD4",
    "web_order_line_item_id": "1000000037544589",
    "original_purchase_date_ms": "1516406580000",
    "expires_date_formatted": "2018-01-31 00:53:10 Etc/GMT",
    "purchase_date": "2018-01-31 00:23:10 Etc/GMT",
    "is_in_intro_offer_period": "false",
    "purchase_date_ms": "1517358190000",
    "expires_date_formatted_pst": "2018-01-30 16:53:10 America/Los_Angeles",
    "is_trial_period": "false",
    "purchase_date_pst": "2018-01-30 16:23:10 America/Los_Angeles",
    "original_purchase_date": "2018-01-20 00:03:00 Etc/GMT",
    "item_id": "1326212778"
  },
  "expiration_intent": "1",
  "is_in_billing_retry_period": "0"
}
```

---

### æ”¶æ®è§£æ

è¯¦è§å®˜æ–¹è§£é‡Šï¼š[https://developer.apple.com/documentation/appstorereceipts/status][5]{:target="_blank"}

{:class="table table-striped table-bordered table-hover"}
| <img style="width:80px">Status | Description |
| :-----: | :------- |
| 21000 | The request to the AppStore was not made using the HTTP POST request method.|
| 21001 | This status code is no longer sent by the AppStore.|
| 21002 | The data in the receipt-data property was malformed or the service experienced a temporary issue. Try again.|
| 21003 | The receipt could not be authenticated.|
| 21004 | The shared secret you provided does not match the shared secret on file for your account.|
| 21005 | The receipt server was temporarily unable to provide the receipt. Try again.|
| 21006 | This receipt is valid but the subscription has expired. When this status code is returned to your server, the receipt data is also decoded and returned as part of the response. `Only returned for iOS 6-style transaction receipts for auto-renewable subscriptions.`|
| 21007 | This receipt is from the test environment, but it was sent to the production environment for verification.|
| 21008 | This receipt is from the production environment, but it was sent to the test environment for verification.|
| 21009 | Internal data access error. Try again later.|
| 21010 | The user account cannot be found or has been deleted.|
| 21100 | Internal data access error. Try again later.|
| ...   | Internal data access error. Try again later.|
| 21199 | Internal data access error. Try again later.|

---

## æ²™ç›’ç¯å¢ƒ

åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æµ‹è¯•åº”ç”¨æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸çš„è¿›è¡Œæ”¯ä»˜ï¼Œä½†æ˜¯åˆä¸å¯èƒ½æ¯ä¸€æ¬¡æµ‹è¯•éƒ½è¿›è¡Œå®é™…çš„æ”¯ä»˜ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨è‹¹æœæä¾›çš„ Sandbox Store æµ‹è¯•ã€‚è‹¹æœæä¾›äº†æ²™ç›’è´¦å·çš„æ–¹å¼ï¼Œè¿™ä¸ªæ²™ç®±è´¦å·å…¶å®æ˜¯è™šæ‹Ÿçš„AppleIDï¼Œåœ¨å¼€å‘è€…è´¦å·åå°çš„iTune Connectä¸Šé…ç½®äº†ä¹‹åå°±èƒ½ä½¿ç”¨æ²™ç›’è´¦å·æµ‹è¯•å†…è´­ã€‚StoreKitä¸èƒ½åœ¨iOSæ¨¡æ‹Ÿå™¨ä¸­ä½¿ç”¨ï¼Œå› æ­¤ï¼Œæµ‹è¯•StoreKitå¿…é¡»åœ¨çœŸæœºä¸Šè¿›è¡Œã€‚

```shell
Sandboxç¯å¢ƒéªŒè¯ä»˜æ¬¾æ”¶æ®(receipt): https://sandbox.itunes.apple.com/verifyReceipt
Productç¯å¢ƒéªŒè¯ä»˜æ¬¾æ”¶æ®(receipt): https://buy.itunes.apple.com/verifyReceipt
```

---

### æ²™ç›’è´¦å·

1. åœ¨iPhoneä¸Šå®‰è£…æµ‹è¯•åŒ…
2. é€€å‡ºiPhoneçš„AppStoreè´¦å·ï¼Œè®¾ç½® iTunes Store ä¸ AppStore -> é€‰ä¸­AppleID -> é€€å‡ºç™»å½•ã€‚æ³¨æ„âš ï¸ï¼šé€€å‡ºä¹‹åï¼Œä¸éœ€è¦åœ¨ AppStore ç™»å½•æ²™ç›’è´¦å·ï¼Œå› ä¸ºæ²™ç›’è´¦å·æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„AppleIDï¼Œå› æ­¤ä¸èƒ½ç›´æ¥ç™»å½•ã€‚åªèƒ½ä½¿ç”¨åœ¨æ”¯ä»˜æ—¶ä½¿ç”¨ã€‚
3. åœ¨æµ‹è¯•åŒ…ä¸­ç‚¹å‡»è´­ä¹°å•†å“ï¼Œç³»ç»Ÿä¼šæç¤ºä½ è¿›è¡Œç™»å½•ï¼Œè¿™é‡Œç‚¹å‡»"ä½¿ç”¨ç°æœ‰çš„AppleID"åè¾“å…¥æ²™ç›’æµ‹è¯•è´¦å·è¿›è¡Œç™»å½•ã€‚
4. ç‚¹å‡»ç¡®è®¤è´­ä¹°ï¼Œè´­ä¹°æˆåŠŸã€‚

---

### æ²™ç›’æµ‹è¯•

æ²™ç›’ç¯å¢ƒä¸‹è‡ªåŠ¨ç»­è´¹è®¢é˜…æ—¶ï¼Œæ—¶é™ä¼šç¼©çŸ­ã€‚

{:class="table table-striped table-bordered table-hover"}
|ç”Ÿäº§è‡ªåŠ¨ç»­è´¹å‘¨æœŸ|æ²™ç›’è‡ªåŠ¨ç»­è´¹å‘¨æœŸ|
| :-----: | :-------: |
| 1å‘¨  |  3åˆ†é’Ÿ|
| 1ä¸ªæœˆ | 5åˆ†é’Ÿ|
| 2ä¸ªæœˆ | 10åˆ†é’Ÿ|
| 3ä¸ªæœˆ | 15åˆ†é’Ÿ|
| 6ä¸ªæœˆ | 30åˆ†é’Ÿ|
| 1å¹´  |  1å°æ—¶|

---

### æ²™ç›’è¯†åˆ«

* è§£æä»˜æ¬¾æ”¶æ®(receipt)ä¸­çš„ environment å­—æ®µï¼Œåˆ¤æ–­ environment=Sandboxã€‚
* æ ¹æ®ç”Ÿäº§ç¯å¢ƒæ”¶æ®éªŒè¯æ¥å£è¿”å›çš„çŠ¶æ€ç ã€‚å¦‚æœ status=21007ï¼Œåˆ™è¡¨ç¤ºå½“å‰çš„æ”¶æ®ä¸ºæ²™ç›’ç¯å¢ƒæ”¶æ®ã€‚

---

### è‹¹æœå®¡æ ¸

è‹¹æœå®¡æ ¸APPæ˜¯åœ¨æ²™ç›’ç¯å¢ƒä¸‹éªŒè¯å……å€¼ç›¸å…³åŠŸèƒ½çš„ã€‚å› æ­¤ï¼Œå½“APPæäº¤è‹¹æœå®¡æ ¸æ—¶ï¼ŒæœåŠ¡ç«¯éœ€æ¢æˆæ²™ç›’ç¯å¢ƒï¼Œå¦åˆ™å°±æ— æ³•é€šè¿‡è‹¹æœå®¡æ ¸ã€‚

ç–‘é—®ğŸ¤”ï¸ï¼šç”Ÿäº§å’Œæ²™ç›’ç¯å¢ƒçš„æ”¶æ®éœ€è¦åˆ‡æ¢ä¸åŒçš„éªŒè¯æ¥å£ï¼Œå¦‚ä½•ç®€åŒ–ï¼Ÿ

æœ€ä½³å®è·µï¼šé¦–å…ˆä½¿ç”¨ production URL éªŒè¯æ”¶æ®ï¼Œå¦‚æœæ”¶åˆ°äº†21007çš„çŠ¶æ€ç ï¼Œé‚£ä¹ˆç»§ç»­ä½¿ç”¨sandbox URLè¿›è¡ŒéªŒè¯ã€‚éµå¾ªè¿™ç§æ–¹æ³•å¯ä»¥ç¡®ä¿ä½ çš„åº”ç”¨ç¨‹åºåœ¨æµ‹è¯•ã€Appå®¡æ ¸ä»¥åŠAppStoreä¸­è¿è¡Œæ—¶ï¼Œä¸éœ€è¦åœ¨urlä¹‹é—´åˆ‡æ¢ã€‚

---

## å†…è´­é€€æ¬¾

---

### é€€æ¬¾æ”¿ç­–

é’ˆå¯¹é€€æ¬¾ï¼Œä¸åŒå›½å®¶æˆ–åœ°åŒºä¼šæœ‰ä¸åŒçš„â€œæ— æ¡ä»¶é€€æ¬¾æœŸé™â€ã€‚
AppStore å•†åº—é€€æ¬¾æ”¿ç­–ï¼š

* æ¬§ç›ŸåŒºï¼š 14å¤©æ— æ¡ä»¶é€€æ¬¾ã€‚
* ä¸­å›½å°æ¹¾ï¼š7å¤©æ— æ¡ä»¶é€€æ¬¾ã€‚
* ä¸­å›½/ç¾å›½/éŸ©å›½ç­‰å…¶å®ƒå¤§å¤šæ•°å›½å®¶ï¼š90å¤©æœ‰æ¡ä»¶é€€æ¬¾ã€‚

æ³¨ï¼šä¸­å›½åŒº AppStore çš„å…·ä½“é€€æ¬¾æ”¿ç­–ï¼šä¸€ä¸ª AppleId æœ‰ä¸€æ¬¡æ— æ¡ä»¶é€€æ¬¾æœºä¼šï¼Œä¸€å¹´2æ¬¡æœ‰æ¡ä»¶é€€æ¬¾ï¼Œç¬¬3æ¬¡é€€æ¬¾ä¼šéå¸¸éš¾ã€‚è‡³äºé€€æ¬¾åˆ°è´¦æ—¶é—´å¿«ä¸º36å°æ—¶å†…ï¼Œä¹Ÿæœ‰7-15ä¸ªå·¥ä½œæ—¥é€€è¿˜ã€‚

---

### é€€æ¬¾æ–¹å¼

ç”¨æˆ·å¯ä»¥é€šè¿‡é‚£äº›æ–¹å¼ç”³è¯·é€€æ¬¾ï¼š

* è”ç³»Appleå®¢æˆ·æ”¯æŒå¹¶è¦æ±‚é€€æ¬¾
* ç™»å½•å¹¶ä½¿ç”¨Appleçš„è‡ªåŠ©æœåŠ¡å·¥å…· reportaproblem.apple.com è¦æ±‚é€€æ¬¾
* è¦æ±‚ä»–ä»¬çš„ä»˜æ¬¾æ–¹å¼å‘è¡Œäººé€€æ¬¾ ï¼ˆæ¯”å¦‚è¦æ±‚é“¶è¡Œå–æ¶ˆæ‰£è´¹ï¼Œæˆ–è€…é»‘å¡æ— æ³•æ‰£è´¹ç­‰ï¼‰

---

### é€€æ¬¾é€šçŸ¥

åœ¨ Apple å…¨çƒå¼€å‘è€…å¤§ä¼š( [WWDC2020][3]{:target="_blank"} )ä¸Šï¼ŒAppleå®£å¸ƒä»2020å¹´06æœˆ24æ—¥å¼€å§‹ï¼Œé’ˆå¯¹ AppStore å†…è´­é¡¹ç›®çš„é€€æ¬¾é€šçŸ¥ç°å·²å¯ç”¨ã€‚AppStore æœåŠ¡å™¨é€šçŸ¥ç°åœ¨åŒ…å«æ‰€æœ‰ç±»å‹çš„ AppStore å†…è´­é¡¹ç›®çš„é€€æ¬¾é€šçŸ¥ (åŒ…æ‹¬æ¶ˆè€—å‹é¡¹ç›®ã€éæ¶ˆè€—å‹é¡¹ç›®å’Œéç»­æœŸè®¢é˜…)ï¼Œè¯¦è§ï¼š[https://developer.apple.com/videos/play/wwdc2020/10661/][4]{:target="_blank"}ã€‚

2020å¹´06æœˆ24æ—¥å¼€å§‹ï¼Œæ–°çš„é€€æ¬¾æµç¨‹ï¼š

<div class="mermaid">
sequenceDiagram
	participant Customer
	participant Apple
	participant Developer
	Customer->>Developer: Purchases 100 gems(è´­ä¹°100å®çŸ³)
	Customer->>Developer: Consumes 100 gems(æ¶ˆè´¹100å®çŸ³)
	Customer->>Apple: Contacts Apple for support(é¡¾å®¢è”ç³»è‹¹æœç”³è¯·é€€æ¬¾)
	Apple->>Apple: Issues refund(è‹¹æœå‘èµ·é€€æ¬¾)
	Apple->>Developer: Send refund notification(å‘é€é€€æ¬¾é€šçŸ¥)
	Apple->>Customer: Contacts you for game compensation(é€šçŸ¥ç”¨æˆ·é€€æ¬¾æˆåŠŸ)
	Developer->>Developer: Check for refunded payment(å¼€å‘è€…æ£€æŸ¥é€€æ¬¾è®¢å•)
</div>

åœ¨ AppStore æœåŠ¡ç«¯é€šçŸ¥ä¸­ï¼Œé’ˆå¯¹æ¶ˆè€—å‹é¡¹ç›®ã€éæ¶ˆè€—å‹é¡¹ç›®å’Œéç»­æœŸè®¢é˜…ä¸‰ç±»å•†å“çš„é€€æ¬¾ï¼Œå¢æ·»äº†æ–°çš„é€šçŸ¥ç±»å‹ï¼š`é€€æ¬¾ï¼ˆREFUNDï¼‰`ã€‚

æ³¨æ„âš ï¸ï¼Œä¸åŒäºå–æ¶ˆï¼ˆCANCELï¼‰é€šçŸ¥ç±»å‹ï¼Œå–æ¶ˆé€šçŸ¥ç±»å‹é’ˆå¯¹çš„æ˜¯è‡ªåŠ¨ç»­æœŸè®¢é˜…ç±»å‹å•†å“ï¼Œç”¨æˆ·é€šè¿‡ AppleCare æ”¯æŒå–æ¶ˆè®¢é˜…å¹¶é€€è¿˜è´­ä¹°æ¬¾é¡¹æ—¶è§¦å‘ã€‚

åœ¨ unified_receipt.latest_receipt_info æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­åŒ…å«çš„æœ€è¿‘çš„100æ¬¡åº”ç”¨å†…è´­ä¹°äº¤æ˜“ï¼ŒåŒ…æ‹¬æ­£å¸¸å’Œé€€æ¬¾çš„äº¤æ˜“ã€‚
å¦‚æœæ˜¯é€€æ¬¾çš„äº¤æ˜“ï¼Œäº¤æ˜“çš„æ”¶æ®ä¿¡æ¯ä¸­ä¼šåŒ…å«é€€æ¬¾æ—¶é—´ï¼ˆcancellation_date_msï¼‰å’Œé€€æ¬¾åŸå› ï¼ˆcancellation_reasonï¼‰ã€‚

æœåŠ¡å™¨åº”å‘é€HTTPçŠ¶æ€ä»£ç ï¼Œä»¥è¡¨ç¤ºæœåŠ¡å™¨åˆ°æœåŠ¡å™¨çš„é€šçŸ¥æ¥æ”¶æ˜¯å¦æˆåŠŸï¼š

* å¦‚æœå›è°ƒæ¥æ”¶æˆåŠŸï¼Œåˆ™å‘é€ HTTP 200ã€‚æ‚¨çš„æœåŠ¡å™¨ä¸éœ€è¦è¿”å›æ•°æ®ã€‚
* å¦‚æœå›è°ƒæ¥æ”¶ä¸æˆåŠŸï¼Œè¯·å‘é€ HTTP 50x æˆ– 40x è®© AppStore é‡è¯•è¯¥é€šçŸ¥ã€‚AppStoreåœ¨ä¸€æ®µæ—¶é—´å†…å°è¯•é‡è¯•è¯¥é€šçŸ¥ï¼Œä½†åœ¨è¿ç»­å¤±è´¥å°è¯•åæœ€ç»ˆåœæ­¢ï¼ˆ3æ¬¡ï¼‰ï¼›

æ³¨æ„äº‹é¡¹ï¼š

* å½“æ‚¨ä½¿ç”¨åŒ…å«é€€æ¬¾äº¤æ˜“çš„æ”¶æ® transaction_data å‘è‹¹æœæœåŠ¡å™¨æ ¡éªŒ verifyReceipt  æ—¶ï¼ŒJSONå“åº”ä¸­ä¸å­˜åœ¨é€€æ¬¾äº¤æ˜“ï¼Œè‡ªåŠ¨ç»­è®¢è®¢é˜…é™¤å¤–ã€‚
* æ”¶åˆ° REFUND é€šçŸ¥æ—¶ï¼Œæ‚¨æœ‰è´£ä»»ä¸ºæ¯ç¬”é€€æ¬¾äº¤æ˜“å­˜å‚¨ï¼Œç›‘æ§å¹¶é‡‡å–é€‚å½“çš„æªæ–½ã€‚ï¼ˆå› ä¸ºè‹¹æœåªé€šçŸ¥ä¸€æ¬¡ï¼Œæš‚æ—¶æ— æ³•åœ¨è‹¹æœåå°æŸ¥è¯¢é€€æ¬¾çš„è®¢å•ã€‚ä¹Ÿä¸èƒ½ç”±å¼€å‘è€…ä¸»åŠ¨å»è‹¹æœæœåŠ¡å™¨æŸ¥è¯¢ã€‚ï¼‰

é€€æ¬¾ï¼ˆREFUNDï¼‰é€šçŸ¥ç±»å‹é€šçŸ¥çš„ç»“æ„å¦‚ä¸‹ï¼š

```json
{
    "notification_type":"REFUND",
    "password":"...",
    "environment":"PROD",
    "latest_receipt":"...",
    "latest_receipt_info":{
        "cancellation_reason":"0",
        "is_trial_period":"false",
        "is_in_intro_offer_period":"false",
        "unique_identifier":"00008020-0004482A3628002E",
        "unique_vendor_identifier":"0C4C3E40-21D8-4BC4-992F-1CB9A6CAEA4C",
        "cancellation_date":"2020-07-28 06:00:53 Etc/GMT",
        "cancellation_date_ms":"1595916053000",
        "cancellation_date_pst":"2020-07-27 23:00:53 America/Los_Angeles",
        "purchase_date":"2020-07-27 07:58:43 Etc/GMT",
        "purchase_date_ms":"1595836723000",
        "purchase_date_pst":"2020-07-27 00:58:43 America/Los_Angeles",
        "original_purchase_date":"2020-07-27 07:58:43 Etc/GMT",
        "original_purchase_date_ms":"1595836723000",
        "original_purchase_date_pst":"2020-07-27 00:58:43 America/Los_Angeles",
        "item_id":"1146327846",
        "app_item_id":"774384491",
        "version_external_identifier":"836917695",
        "bid":"...",
        "product_id":"...",
        "transaction_id":"...",
        "original_transaction_id":"...",
        "quantity":"1",
        "bvrs":"4.98.00.1"
    },
    "unified_receipt":{
        "status":0,
        "environment":"Production",
        "latest_receipt_info":[
            {
                "quantity":"1",
                "product_id":"...",
                "transaction_id":"...",
                "purchase_date":"2020-07-27 07:58:43 Etc/GMT",
                "purchase_date_ms":"1595836723000",
                "purchase_date_pst":"2020-07-27 00:58:43 America/Los_Angeles",
                "original_purchase_date":"2020-07-27 07:58:43 Etc/GMT",
                "original_purchase_date_ms":"1595836723000",
                "original_purchase_date_pst":"2020-07-27 00:58:43 America/Los_Angeles",
                "is_trial_period":"false",
                "original_transaction_id":"...",
                "cancellation_date":"2020-07-28 06:00:53 Etc/GMT",
                "cancellation_date_ms":"1595916053000",
                "cancellation_date_pst":"2020-07-27 23:00:53 America/Los_Angeles",
                "cancellation_reason":"0"
            }
        ],
        "latest_receipt":"..."
    },
    "bid":"...",
    "bvrs":"4.98.00.1"
}
```

---

### é€€æ¬¾å¤„ç†

![potential-actions](/assets/img/potential-actions.jpeg){:width="100%"}

---

## æœåŠ¡å™¨é€šçŸ¥

ä½¿ç”¨æ¥è‡ª AppStore çš„æœåŠ¡å™¨é€šçŸ¥æ¥ç›‘è§†å’Œå“åº”ç”¨æˆ·çš„è®¢é˜…çŠ¶æ€æ›´æ”¹ã€‚å¯ç”¨ AppStore æœåŠ¡å™¨é€šçŸ¥åŠŸèƒ½æ˜¯å¯é€‰çš„ï¼Œä½†å»ºè®®è¿™æ ·åšï¼Œç‰¹åˆ«æ˜¯åœ¨è·¨å¤šä¸ªå¹³å°æä¾›è®¢é˜…æœåŠ¡ä¸”éœ€è¦ä¿æŒè®¢é˜…è®°å½•æ›´æ–°çš„æƒ…å†µä¸‹ã€‚
è®¾ç½®æœåŠ¡å™¨åï¼Œæ‚¨å¯ä»¥éšæ—¶é€šè¿‡åœ¨ App Store Connect ä¸­æ·»åŠ æœåŠ¡å™¨URLæ¥å¼€å§‹æ¥æ”¶é€šçŸ¥ã€‚ å°†é€šçŸ¥ä¸æ”¶æ®éªŒè¯ç»“åˆä½¿ç”¨å¯ä»¥éªŒè¯ç”¨æˆ·çš„å½“å‰è®¢é˜…çŠ¶æ€ï¼Œå¹¶æ ¹æ®è¯¥çŠ¶æ€ä¸ºç”¨æˆ·æä¾›æœåŠ¡æˆ–ä¿ƒé”€ä¼˜æƒ ã€‚
è¯¦è§ï¼š[https://developer.apple.com/documentation/storekit/in-app_purchase/subscriptions_and_offers/enabling_server-to-server_notifications][6]{:target="_blank"}

---

### é…ç½®æœåŠ¡å™¨é€šçŸ¥

1. åœ¨æœåŠ¡å™¨ä¸Šæ”¯æŒ App Transport Securityï¼ˆATSï¼‰ã€‚åœ¨å‘é€é€šçŸ¥ä¹‹å‰ï¼ŒAppStoreå¿…é¡»ä½¿ç”¨ATSåè®®ä¸æ‚¨çš„æœåŠ¡å™¨å»ºç«‹å®‰å…¨çš„ç½‘ç»œè¿æ¥ã€‚
2. ç¡®å®šåº”ç”¨æœåŠ¡å™¨æä¾›çš„URLå¯ç”¨äºè®¢é˜…çŠ¶æ€æ›´æ–°ã€‚
3. åœ¨AppStore Connectä¸­ä¸ºæ‚¨çš„åº”ç”¨é…ç½®è®¢é˜…çŠ¶æ€URLã€‚è¯·å‚é˜…ï¼šhttps://help.apple.com/app-store-connect/#/dev0067a330b

---

### æœåŠ¡å™¨é€šçŸ¥ç±»å‹

AppStore é€šè¿‡HTTPåè®®çš„POSTè¯·æ±‚ï¼Œå°†JSONæ ¼å¼çš„é€šçŸ¥æ¶ˆæ¯ä¼ é€’ç»™ä¸šåŠ¡çš„åº”ç”¨æœåŠ¡å™¨ï¼Œä»¥å¤„ç†çš„è®¢é˜…äº‹ä»¶ã€‚

è¯¦è§ï¼š[https://developer.apple.com/documentation/appstoreservernotifications/notification_type][7]{:target="_blank"}

---

#### INITIAL_BUY

> Occurs at the initial purchase of the subscription. Store latest_receipt on your server as a token to verify the userâ€™s subscription status at any time, by validating it with the App Store.

![INITIAL_BUY](/assets/img/appstore-in-app-purchase/INITIAL_BUY.png){:width="100%"}

å­˜å‚¨äº‹ä»¶æ¶ˆæ¯ä¸­çš„latest_receiptå­—æ®µï¼Œä½œä¸ºé€šè¿‡AppStoreæŸ¥è¯¢ç”¨æˆ·è®¢é˜…çŠ¶æ€çš„å‡­è¯ã€‚

è§¦å‘æ¡ä»¶ï¼š

* åœ¨ç”¨æˆ·é¦–æ¬¡è´­ä¹°è®¢é˜…äº§å“æ—¶è§¦å‘ï¼›

---

#### CANCEL

> Indicates that either Apple customer support canceled the subscription or the user upgraded their subscription. The cancellation_date key contains the date and time of the change.

![CANCEL](/assets/img/appstore-in-app-purchase/CANCEL.png){:width="100%"}

äº‹ä»¶æ¶ˆæ¯ä¸­çš„cancellation_dateå­—æ®µåŒ…å«æ›´æ”¹çš„æ—¥æœŸå’Œæ—¶é—´ï¼Œç”¨äºè·å–iOSç»­è´¹é€€æ¬¾ä¿¡æ¯ã€‚é€šè¿‡iOSè®¾ç½®å–æ¶ˆè®¢é˜…æ—¶ï¼Œä¸ä¼šå‘é€CANCELäº‹ä»¶ï¼Œè€Œæ˜¯å‘é€DID_CHANGE_RENEWAL_STATUSäº‹ä»¶ã€‚

è§¦å‘æ¡ä»¶ï¼š

* ç”¨æˆ·é€šè¿‡AppleCareæ”¯æŒå–æ¶ˆè®¢é˜…å¹¶é€€è¿˜è´­ä¹°æ¬¾é¡¹ï¼›
* ç”¨æˆ·å‡çº§è®¢é˜…äº§å“ï¼›

---

#### DID_CHANGE_RENEWAL_STATUS

> Indicates a change in the subscription renewal status. Check auto_renew_status_change_date_ms and auto_renew_status in the JSON response to know the date and time of the last status update and the current renewal status.

![DID_CHANGE_RENEWAL_STATUS](/assets/img/appstore-in-app-purchase/DID_CHANGE_RENEWAL_STATUS.png){:width="100%"}

ç”¨äºè·å–è®¢é˜…çŠ¶æ€å˜æ›´ï¼Œé€šè¿‡çš„auto_renew_statuså’Œauto_renew_status_change_date_msè·å–å½“å‰çš„è®¢é˜…çŠ¶æ€ä»¥åŠä¸Šæ¬¡çŠ¶æ€æ›´æ–°çš„æ—¶é—´ã€‚æ³¨æ„ï¼šæ­¤äº‹ä»¶ä¸CANCELäº‹ä»¶å®¹æ˜“æ··æ·†ï¼ŒCANCELäº‹ä»¶é€šè¿‡AppleCareæ”¯æŒå–æ¶ˆè®¢é˜…å¹¶é€€è¿˜è´­ä¹°æ¬¾é¡¹æ—¶è§¦å‘ã€‚

è§¦å‘æ¡ä»¶ï¼š

* å½“è®¢é˜…çŠ¶æ€å‘ç”Ÿçš„æ›´æ”¹æ—¶è§¦å‘ï¼ŒåŒ…æ‹¬å·²è®¢é˜…çŠ¶æ€æ—¶å–æ¶ˆè®¢é˜…æˆ–æœªè®¢é˜…çŠ¶æ€æ—¶é‡æ–°è®¢é˜…ï¼›

1. è®¢é˜…çŠ¶æ€å˜æ›´ï¼šå–æ¶ˆè®¢é˜…ï¼ˆè®¢é˜…æœåŠ¡æœªè¿‡æœŸï¼‰
åˆ¤å®šæ¡ä»¶ï¼šauto_renew_status == 0 && status = 0
è¿‡æœŸå¤„ç†ï¼š
ç»­è´¹è®¢é˜…çŠ¶æ€ï¼ˆrenewStatusï¼‰ï¼š 1 -> 0
æœ€åç»­è´¹æ—¶é—´ï¼ˆLastRenewalTimeï¼‰ï¼šlatest_receipt_info.purchase_date_ms
ä¸‹æ¬¡ç»­è´¹æ—¶é—´ï¼ˆnextRenewalTimeï¼‰ï¼šlatest_receipt_info.expires_date

2. è®¢é˜…çŠ¶æ€å˜æ›´ï¼šå–æ¶ˆè®¢é˜…ï¼ˆè®¢é˜…æœåŠ¡å·²è¿‡æœŸï¼‰
åˆ¤å®šæ¡ä»¶ï¼šauto_renew_status == 0 && status = 0
è¿‡æœŸå¤„ç†ï¼š
ç»­è´¹è®¢é˜…çŠ¶æ€ï¼ˆrenewStatusï¼‰ï¼š 1 -> 0
æœ€åç»­è´¹æ—¶é—´ï¼ˆLastRenewalTimeï¼‰ï¼šlatest_expired_receipt_info.purchase_date_ms
ä¸‹æ¬¡ç»­è´¹æ—¶é—´ï¼ˆnextRenewalTimeï¼‰ï¼šlatest_expired_receipt_info.expires_date

3. è®¢é˜…çŠ¶æ€å˜æ›´ï¼šæ¢å¤è®¢é˜…ï¼ˆè®¢é˜…æœåŠ¡æœªè¿‡æœŸï¼‰
åˆ¤å®šæ¡ä»¶ï¼šauto_renew_status == 1 && status = 0
è¿‡æœŸå¤„ç†ï¼š
ç»­è´¹è®¢é˜…çŠ¶æ€ï¼ˆrenewStatusï¼‰ï¼š 0 -> 1
æœ€åç»­è´¹æ—¶é—´ï¼ˆLastRenewalTimeï¼‰ï¼šlatest_receipt_info.purchase_date_ms
ä¸‹æ¬¡ç»­è´¹æ—¶é—´ï¼ˆnextRenewalTimeï¼‰ï¼šlatest_receipt_info.expires_date

---

#### RENEWAL

>Indicates successful automatic renewal of an expired subscription that failed to renew in the past. Check expires_date to determine the next renewal date and time.

![RENEWAL](/assets/img/appstore-in-app-purchase/RENEWAL.png){:width="100%"}

è¡¨ç¤ºæˆåŠŸè‡ªåŠ¨ç»­è®¢è¿‡å»æ— æ³•ç»­è®¢çš„è¿‡æœŸè®¢é˜…ã€‚æ£€æŸ¥expires_dateï¼Œä»¥ç¡®å®šä¸‹ä¸€ä¸ªç»­è®¢æ—¥æœŸå’Œæ—¶é—´ã€‚

æ³¨æ„âš ï¸ï¼šRENEWALäº‹ä»¶çš„å‘½åå®¹æ˜“è®©äººæ··æ·†ï¼Œè®©äººè¯¯ä»¥ä¸ºæ˜¯æ¯æ¬¡è‡ªåŠ¨ç»­è®¢çš„æ—¶å€™è§¦å‘è¯¥äº‹ä»¶ã€‚ç›¸åï¼Œåº”è¯¥åœ¨è®¢é˜…å‘¨æœŸçš„è¿‡æœŸæ—¶é—´`expiration_date`å‰åï¼Œé€šè¿‡è‹¹æœæä¾›çš„æ”¶æ®æ ¡éªŒæ¥å£`/VerifyReceipt`æ¥æ£€æŸ¥è®¢é˜…çŠ¶æ€ï¼Œè·å–ä¸‹ä¸€ä¸ªè®¢é˜…å‘¨æœŸçš„ä¿¡æ¯ã€‚

è§¦å‘æ¡ä»¶ï¼š

* ç”±äºæ— æ³•ä»ç”¨æˆ·è´¦æˆ·æˆåŠŸæ‰£æ¬¾ï¼Œè®¢é˜…è¢«è‡ªåŠ¨å–æ¶ˆä¸€æ®µäº‹ä»¶åï¼Œç”¨æˆ·é‡æ–°ç»­è®¢æ—¶ï¼Œä¼šè§¦å‘RENEWALäº‹ä»¶ï¼›

---

#### INTERACTIVE_RENEWAL

>Indicates the customer renewed a subscription interactively, either by using your appâ€™s interface, or on the App Store in the account's Subscriptions settings. Make service available immediately.

![INTERACTIVE_RENEWAL](/assets/img/appstore-in-app-purchase/INTERACTIVE_RENEWAL.png){:width="100%"}

è¡¨ç¤ºå®¢æˆ·ä½¿ç”¨æ‚¨çš„åº”ç”¨ç¨‹åºç•Œé¢æˆ–åœ¨è¯¥å¸æˆ·çš„â€œè®¢é˜…â€è®¾ç½®ä¸­çš„App Storeä¸Šä»¥äº¤äº’æ–¹å¼ç»­è®¢äº†è®¢é˜…ã€‚éœ€è¦ç«‹å³æä¾›æœåŠ¡ã€‚

è§¦å‘æ¡ä»¶

* ç”¨æˆ·å–æ¶ˆäº†è®¢é˜…ï¼Œä¸€æ®µæ—¶é—´åç”¨æˆ·é€šè¿‡AppStoreäº¤äº’é¡µé¢é‡æ–°è®¢é˜…äº§å“ï¼Œä¼šè§¦å‘INTERACTIVE_RENEWALäº‹ä»¶ã€‚

A new subscription (which is listed in clause 2) may differ from the subscription from clause 1, but they both must belong to the same shopping group. For example, a user may cancel a subscription to the Bronze tariff plan and after a while resume the subscription by selecting the Gold plan. In this case, Apple will send the INTERACTIVE_RENEWAL event to your server (provided that the Bronze and Gold subscriptions belong to the same shopping group). You can read more about subscription groups here .

æ–°çš„è®¢é˜…ï¼ˆåœ¨ç¬¬2èŠ‚ä¸­åˆ—å‡ºï¼‰å¯èƒ½ä¸ç¬¬1æ¡ä¸­çš„è®¢é˜…ä¸åŒï¼Œä½†å®ƒä»¬éƒ½å¿…é¡»å±äºåŒä¸€è´­ç‰©ç»„ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å¯ä»¥å–æ¶ˆå¯¹é’é“œè´¹ç‡è®¡åˆ’çš„è®¢é˜…ï¼Œå¹¶åœ¨ä¸€æ®µæ—¶é—´åé€šè¿‡é€‰æ‹©é»„é‡‘è®¡åˆ’æ¢å¤è®¢é˜…ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒAppleä¼šå°†INTERACTIVE_RENEWALäº‹ä»¶å‘é€åˆ°æ‚¨çš„æœåŠ¡å™¨ï¼ˆå‡è®¾Bronzeå’ŒGoldè®¢é˜…å±äºåŒä¸€è´­ç‰©ç»„ï¼‰ã€‚

---

#### DID_CHANGE_RENEWAL_PREF

>Indicates the customer made a change in their subscription plan that takes effect at the next renewal. The currently active plan is not affected.

![DID_CHANGE_RENEWAL_PREF](/assets/img/appstore-in-app-purchase/DID_CHANGE_RENEWAL_PREF.png){:width="100%"}

è¡¨ç¤ºå®¢æˆ·å¯¹å…¶è®¢é˜…è®¡åˆ’è¿›è¡Œäº†æ›´æ”¹ï¼Œè¯¥æ›´æ”¹ä¼šåœ¨ä¸‹ä¸€æ¬¡ç»­è®¢æ—¶ç”Ÿæ•ˆã€‚å½“å‰æ´»åŠ¨çš„è®¡åˆ’ä¸å—å½±å“ï¼›

è§¦å‘æ¡ä»¶ï¼š

* å½“ç”¨æˆ·åœ¨åŒä¸€è®¢é˜…åˆ†ç»„ä¸­ï¼Œä»ä¸€ä¸ªè®¢é˜…å•†å“åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè®¢é˜…å•†å“æ—¶ï¼Œä¼šè§¦å‘DID_CHANGE_RENEWAL_PREFäº‹ä»¶ï¼›

---

#### DID_FAIL_TO_RENEW

>Indicates a subscription that failed to renew due to a billing issue. Check is_in_billing_retry_period to know the current retry status of the subscription, and grace_period_expires_date to know the new service expiration date if the subscription is in a billing grace period.

è¡¨ç¤ºç”±äºè®¡è´¹é—®é¢˜è€Œæ— æ³•ç»­è®¢çš„è®¢é˜…ã€‚å¦‚æœè®¢é˜…å¤„äºè®¡è´¹å®½é™æœŸå†…ï¼Œè¯·æ£€æŸ¥is_in_billing_retry_periodä»¥äº†è§£è®¢é˜…çš„å½“å‰é‡è¯•çŠ¶æ€ï¼Œå¹¶æ£€æŸ¥grace_period_expires_dateä»¥äº†è§£æ–°æœåŠ¡çš„åˆ°æœŸæ—¥æœŸã€‚

---

#### DID_RECOVER

>Indicates successful automatic renewal of an expired subscription that failed to renew in the past. Check expires_date to determine the next renewal date and time.

è¡¨ç¤ºæˆåŠŸè‡ªåŠ¨ç»­è®¢è¿‡å»æ— æ³•ç»­è®¢çš„è¿‡æœŸè®¢é˜…ã€‚æ£€æŸ¥expires_dateï¼Œä»¥ç¡®å®šä¸‹ä¸€ä¸ªç»­è®¢æ—¥æœŸå’Œæ—¶é—´ã€‚

---

## å†…è´­ç›‘æ§

---

### ä¸šåŠ¡ç›‘æ§

* å•†å“åˆ—è¡¨ç›‘æ§ï¼ˆå¤±è´¥ç‡ä¸æ—¶å»¶ï¼‰
* è´­ä¹°ä¸‹å•ç›‘æ§ï¼ˆå¤±è´¥ç‡ä¸æ—¶å»¶ï¼‰
* æ”¶æ®ä¸ŠæŠ¥ç›‘æ§ï¼ˆå¤±è´¥ç‡ä¸æ—¶å»¶ï¼‰
* å†…è´­é€€æ¬¾ç›‘æ§
* æ²™ç›’å……å€¼ç›‘æ§
* åˆ°è´¦å»¶è¿Ÿç›‘æ§

---

### é“¾è·¯ç›‘æ§

è®¿é—®è‹¹æœæ”¶æ®æœåŠ¡å™¨ç½‘ç»œé“¾è·¯ç›‘æ§ï¼Œç›‘æ§å¯è®¿é—®æ€§ä¸æ—¶å»¶

## å†…è´­è´¦å•

å†…è´­è´¦å•çš„å‡ºè´¦å‘¨æœŸæ˜¯T-2ï¼Œè´¦å•çš„ç»Ÿè®¡æ—¶é—´å£å¾„ä¸é€æ˜ï¼Œæ— æ³•é€šè¿‡æ—¥è´¦å•è¿›è¡Œç²¾å‡†çš„å¯¹è´¦ï¼›

é™¤äº†è‹¹æœå®˜æ–¹30%çš„æ‰‹ç»­è´¹æŠ½æˆä»¥å¤–ï¼Œæ¯ä¸ªå›½å®¶éƒ½æœ‰å…¶ç¨è´¹ï¼›

```json
[
  {
    "provider": "APPLE",
    "provider_country": "US",
    "apple_identifier": "...",                  // äº§å“item-id
    "sku": "...",                               // äº§å“sku
    "developer": "",
    "title": "...",                             // äº§å“æè¿°
    "version": "11.4.7",
    "product_type_identifier": "IA1",           // äº§å“ç±»å‹ï¼ˆè¯¦è§ï¼šhttps://rdrr.io/cran/RTConnect/man/kProductTypeIdentifier.htmlï¼‰
    "units": 2,                                 // äº§å“ä»¶æ•°
    "developer_proceeds": 20.63,                // å¼€å‘è€…æ”¶å…¥
    "currency_of_proceeds": "CNY",              // å¼€å‘è€…æ”¶å…¥å¸ç§
    "begin_date": "06/19/2023",
    "end_date": "06/19/2023",
    "customer_price": 30.00,                    // é¡¾å®¢è´­ä¹°ä»·æ ¼
    "customer_currency": "CNY",                 // é¡¾å®¢è´­ä¹°å¸ç§
    "country_code": "CN",                       // é¡¾å®¢å•†åº—å›½å®¶
    "promo_code": "",
    "parent_identifier": "...",
    "subscription": "",
    "period": "",
    "category": "Music",
    "cmb": "",
    "device": "iPhone",
    "supported_platforms": "iOS and watchOS",
    "proceeds_reason": "",
    "preserved_pricing": "",
    "client": "",
    "order_type": ""
  }
]
```


[1]:https://developer.apple.com/cn/in-app-purchase/
[2]:https://developer.apple.com/documentation/storekit/in-app_purchase/handling_refund_notifications
[3]:https://developer.apple.com/wwdc20/
[4]:https://developer.apple.com/videos/play/wwdc2020/10661/
[5]:https://developer.apple.com/documentation/appstorereceipts/status
[6]:https://developer.apple.com/documentation/storekit/in-app_purchase/subscriptions_and_offers/enabling_server-to-server_notifications
[7]:https://developer.apple.com/documentation/appstoreservernotifications/notification_type
